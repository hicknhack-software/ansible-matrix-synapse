---
  # do not include nginx since we sit behin a reverse proxy already so no need for double duty
  # - include: nginx.yaml 

  - name: Add non-standard repositories
    apt_repository:
      repo: "{{ item }}"
      state: present
    with_items:
      - deb http://ftp.debian.org/debian jessie-backports main
      - deb https://matrix.org/packages/debian/ jessie main
      - deb-src https://matrix.org/packages/debian/ jessie main

  - name: Add apt-key for jessie-backports
    apt_key:
      keyserver: pgpkeys.mit.edu
      id: "{{ item }}"
    with_items:
      - 8B48AD6246925553
      - 7638D0442B90D010

  - name: Add an apt signing key
    apt_key:
      url: https://matrix.org/packages/debian/repo-key.asc
      state: present
  - include: apt_upgrade.yml

  - name: Install requirements
    apt:
      name: "{{ item }}"
      state: present
    with_items:
      - apt-transport-https
      - lsof
      - curl
      - python
      - python-pip

  - name: Install requirements from jessie-backports
    apt:
      name: "{{ item }}"
      state: present
      default_release: jessie-backports
    with_items:
      - python-cffi
      - certbot

  - name: Set Debconf values for matrix-synapse
    debconf:
      name: matrix-synapse
      question: "{{item.question}}"
      value: "{{ item.value }}"
      vtype: "{{ item.vtype }}"
    with_items:
      - {question: 'matrix-synapse/report-stats',value: '{{ matrix_synapse_report_stats }}',vtype: 'boolean' }
      - {question: 'matrix-synapse/server-name',value: '{{ matrix_synapse_domain }}',vtype: 'string' }

  - name: Install matrix-synapse
    apt:
      name: matrix-synapse
      state: present
    notify: restart matrix-synapse

  - name: Set Synapse Cache Factor
    lineinfile:
      path: /etc/default/matrix-synapse
      regexp: SYNAPSE_CACHE_FACTOR
      state: present
      line: "SYNAPSE_CACHE_FACTOR={{ matrix_synapse_cache_factor }}"
    notify: restart matrix-synapse

  - name: Change enable_registration state
    lineinfile:
      path: /etc/matrix-synapse/homeserver.yaml
      regexp: "enable_registration: False"
      state: present
      line: "enable_registration: {{ matrix_synapse_enable_registration }}"
    notify: restart matrix-synapse
